<!--
 * @Author: NeiDeMing
 * @Date: 2020-04-17 15:56:57
 * @LastEditors: NeiDeMing
 * @LastEditTime: 2020-05-13 11:11:36
 * @FilePath: \autoJs\electronChanDao\index.html
 -->
<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./public/layui/css/layui.css" media="all">
  <meta rel="last">
  <title>禅道助手</title>
  <style>
    .contain {
      display: flex;
    }

    .contain>div {
      flex: 1;
    }
  </style>
</head>

<body style="margin-bottom: 100px;">
  <input type="hidden" id="gitData">
  <div class="contain">
    <div>
      <button id='getBug'>
        启动禅道定时任务(2,1)
      </button>
      <p>
        <span>上次获取bug数量：<strong id="preBugNum"></strong></span>
      </p>
      <p>
        <span>本次获取bug数量：<strong id="lastBugNum"></strong></span>
      </p>
      <p>
        <span>本次获取bug新增：<strong id="lastAddBugNum"></strong></span>
      </p>
    </div>
    <div>
      <h4 style="color: skyblue;">4月16号开始不同分支开发</h4>
      <h3>禅道BUG状态</h3>
      <label for="dateStart">
        开始时间:
        <input type="date" name="dateStart" id="dateStart">
      </label>
      </br>
      <label for="dateEnd">
        结束时间:
        <input type="date" name="dateEnd" id="dateEnd">
      </label>
      </br>
      <label for="gitBranch">
        选择分支
        <select name="gitBranch" id="gitBranch" title="默认选择develop分支">
          <option value="develop">--</option>
          <option value="develop">develop</option>
          <!-- <option value="feature">feature</option>
          <option value="hotfix">hotfix</option>
          <option value="master">master</option>
          <option value="release">release</option> -->
        </select>
      </label>
      总数：<span id="gitBranch-all">0</span>
      ---
      已请求：<span id="gitBranch-requested">0</span>
      </br>
      <label for="generateTable" style="display: flex;margin-top: 10px;">
        <button class="layui-btn" id="generateTable" name="generateTable">
          生成表格
        </button>
        <button style="margin-left: 10px;" class="layui-btn layui-btn-danger">获取已关闭Bug</button>
        <button style="margin-left: 10px;" class="layui-btn">还原</button>
        <button style="margin-left: 10px;" class="layui-btn" id="exportExcel">导出</button>
      </label>
      <p style="margin-top: 10px;">
        <button class="layui-btn" id="cherry-pick" data-type="getCheckData">单个commit合并(develop2master)</button>
        <button class="layui-btn" id="btn-close" data-value="前端已fix/done，待发包后，请测试。">关闭禅道Bug</button>
      </p>
      <p style="margin-top: 10px;">
        <button class="layui-btn" id="view-done-bug">导出已解决Bug</button>
        <button class="layui-btn" id="view-close-bug">导出已关闭Bug</button>
      </p>
      <p style="color:red">
        1. bugID2508其实对应的是bugID2666
      </p>
      <p style="color:red">
        2. 2636已经合并进Master,因为某些原因，抓取禅道数据会失败
      </p>
    </div>
  </div>
  <div id="qiniuImg-wrap"
    style="display:none;position: fixed;top: 0;width: 100%;height: 100%;z-index: 99;background: grey;overflow: scroll;text-align: center;">
    <img src="" alt="" id="qiniuImg">
  </div>
  <table class="layui-hide" id="chanDaoTable" lay-filter="chanDaoTable"></table>
  <script type="text/javascript">
    require('./renderer')
  </script>
  <script src="./public/layui/layui.js" charset="utf-8"></script>
  <script type="text/html" id="btn-develop2Master">
    <a class="layui-btn layui-btn-xs" lay-event="solved" title="已解决">已解决</a>
    <a class="layui-btn layui-btn-xs" lay-event="preview" title="预览">预览</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="cherry-pick" title="Develop To Master">cherry-pick</a>
  </script>
  <script>
    const {
      cherryPick,
      onSolvedHandle,
      store
    } = require('./renderer')
    const {
      getPicUrl
    } = require('./middlewares/qiniu')
    const qiniuImgDom = document.querySelector('#qiniuImg')
    const qiniuImgWrapDom = document.querySelector('#qiniuImg-wrap')
    document.querySelector('#generateTable').addEventListener('click', (e) => {
      setTable(store.get('chandao-BugStatus'))
    })
    document.documentElement.addEventListener('keydown', event => {
      if (event.isComposing || event.keyCode === 27) {
        qiniuImgWrapDom.style.display = 'none'
      }
      // do something
    })
    // cherryPick()
    function setTable(data) {
      layui.use('table', function () {
        let table = layui.table
        let form = layui.form;

        table.render({
          elem: '#chanDaoTable',
          url: '',
          cellMinWidth: 80,
          height: 500,
          id: 'idTest',
          cols: [
            [{
              type: 'numbers'
            }, {
              type: 'checkbox'
            }, {
              field: 'committed_date',
              title: 'committed_date',
              sort: true
            }, {
              field: 'committer_name',
              title: 'name',
              width: 120,
              sort: true
            }, {
              field: 'message',
              title: 'commit message',
              sort: true
            }, {
              field: 'type',
              title: 'type',
              width: 80,
              sort: true
            }, {
              field: 'typeId',
              title: 'type_id',
              width: 80,
              sort: true
            }, {
              field: 'content',
              title: 'Bug状态',
              width: 100,
              templet: function (d) {
                if (d.content === '已关闭') {
                  return '<span style="color:red;">' + d.content + '</span>'
                }
                return d.content ? d.content : ''
              },
              sort: true
            }, {
              field: 'status',
              title: '获取状态',
              width: 100,
              templet: function (d) {
                if (d.status === '成功') {
                  return '<span style="color:red;">' + d.status + '</span>'
                }
                return d.status ? d.status : ''
              },
              sort: true
            }, {
              field: 'develop2Master',
              title: '2Master',
              sort: true,
              width: 100,
            }, {
              field: '',
              title: '操作',
              toolbar: '#btn-develop2Master',
              fixed: 'right'
            }]
          ],
          data: data,
          limit: 999
        });

        table.on('tool(chanDaoTable)', function (obj) {
          let data = obj.data;
          if (obj.event === 'cherry-pick' && data.content === '已关闭') {
            layer.confirm('Develop 2 Master ?', function (index) {
              console.log(data)
            });
          } else if (obj.event === 'preview') {
            console.log(data)
            qiniuImgWrapDom.style.display = 'block'
            if (data.typeId) {
              qiniuImgDom.src = getPicUrl(data.typeId)
            }
          } else if (obj.event === 'solved') {
            if (data.content === '激活') {
              onSolvedHandle(data, newData => {
                setTable(newData)
              })
            } else {
              layer.alert('此数据不能已解决')
            }
          }
        });
        let active = {
          getCheckData: function () { //获取选中数据
            var checkStatus = table.checkStatus('idTest'),
              data = checkStatus.data;
            console.log(data)
          }
        };
        document.querySelector('#cherry-pick').addEventListener('click', function () {
          let type = this.getAttribute('data-type');
          active[type] ? active[type].call(this) : '';
        });
      });
    }
  </script>
</body>

</html>